name: Deploy Backend and Frontend

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run Docker Compose
        run: docker-compose up --build backend

      - name: Setup Ngrok Tunnel
        uses: dsmirc/ngrok-tunnel-action@cd
        with:
          port: 5000
          ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}
          tunnel_type: http
          timeout: 6h

      - name: Fetch Ngrok URL
        run: |
          NGROK_URL=$(cat tunnelURL.md)
          echo "NGROK_URL=${NGROK_URL}" >> $GITHUB_ENV

      - name: Update Env Var in Frontend
        run: |
          echo "REACT_APP_BACKEND_URL=${NGROK_URL}" >> ./frontend/event-management/.env
          cat ./frontend/event-management/.env

      - name: Update Env Var on Render.com
        run: |
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"value": "'$NGROK_URL'"}' \
            https://api.render.com/v1/env-groups/${{ secrets.ENV_GROUP_ID }}/env-vars/${{ secrets.ENV_VAR_KEY }}

      - name: Trigger Deployment on Render.com
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "do_not_clear"}' \
            https://api.render.com/v1/services/${{ secrets.SERVICE_ID }}/deploys
