{"version":3,"file":"eventController.js","sourceRoot":"/","sources":["controllers/eventController.ts"],"names":[],"mappings":"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","sourcesContent":["import { NextFunction, Request, Response } from \"express\";\r\nimport Event, { Event as EventType } from \"../models/Event\";\r\nimport Hall, { Hall as HallType } from \"../models/Hall\";\r\nimport mongoose from \"mongoose\";\r\nimport { AppError } from \"../middlewares/errorMiddleware\";\r\nimport { upload } from \"../middlewares/uploadImageMiddleware\";\r\nimport { fork } from \"child_process\";\r\nimport path from \"path\";\r\n\r\nexport const createEvent = async (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction\r\n) => {\r\n  upload(req, res, async (err) => {\r\n    if (err) {\r\n      return next(new AppError(err.message, 400));\r\n    }\r\n\r\n    if (!req.file) {\r\n      return res.status(400).json({ message: \"No file selected!\" });\r\n    }\r\n\r\n    try {\r\n      const { name, description, date, hall, tichetPrice } = req.body;\r\n      const hallModel = await Hall.findOne({ name: hall });\r\n\r\n      if (!hallModel) {\r\n        return res.status(404).json({ message: \"Hall not found\" });\r\n      }\r\n\r\n      const eventAlreadyExists = await Event.findOne({ name });\r\n\r\n      if (eventAlreadyExists) {\r\n        return res\r\n          .status(409)\r\n          .json({ message: \"The name of the event already exists\" });\r\n      }\r\n\r\n      const child = fork(\r\n        path.join(__dirname, \"..\", \"..\", \"src\", \"utils\", \"imageProcessor.ts\")\r\n      );\r\n      child.send(req.file.path);\r\n\r\n      child.on(\"message\", async (message: { processedPath: string }) => {\r\n        const { processedPath } = message;\r\n\r\n        const event = new Event({\r\n          name,\r\n          description,\r\n          date,\r\n          tichetPrice,\r\n          hall: hallModel._id,\r\n          seats: [],\r\n          poster: processedPath\r\n        });\r\n\r\n        await event.save();\r\n\r\n        res.status(201).json({\r\n          message: \"Event created successfully\",\r\n          event: { ...event.toObject(), hall: hallModel.name }\r\n        });\r\n      });\r\n\r\n      child.on(\"error\", (error) => {\r\n        next(new AppError(\"Error processing image\", 500));\r\n      });\r\n    } catch (error) {\r\n      next(new AppError(\"Error creating event\", 400));\r\n    }\r\n  });\r\n};\r\n\r\nexport const getAllEvents = async (\r\n  req: Request & {\r\n    query?: {\r\n      page?: number;\r\n      price?: number;\r\n      date?: Date;\r\n      hall?: string;\r\n      seatsPercentage?: number;\r\n    };\r\n  },\r\n  res: Response,\r\n  next: NextFunction\r\n) => {\r\n  try {\r\n    const {\r\n      price,\r\n      date,\r\n      hall,\r\n      seatsPercentage,\r\n      search\r\n    }: {\r\n      price?: number;\r\n      date?: string;\r\n      hall?: string;\r\n      seatsPercentage?: number;\r\n      search?: string;\r\n    } = {\r\n      ...req.query,\r\n      date: req.query.date?.toString()\r\n    };\r\n\r\n    const page: number = req.query.page ? +req.query.page : 1;\r\n    const skip: number = (page - 1) * 10;\r\n    const [startDate, endDate] = (date || \"\").split(\"|\") as [string, string];\r\n    const hallId = hall ? (await Hall.findOne({ name: hall }))?._id : null;\r\n\r\n    const currentEvents = (\r\n      (await Event.find({\r\n        ...(date\r\n          ? {\r\n              date: {\r\n                $gte: new Date(+startDate),\r\n                $lte: new Date(+endDate)\r\n              }\r\n            }\r\n          : { date: { $gte: new Date() } }),\r\n        ...(price ? { tichetPrice: { $gte: price } } : {}),\r\n        ...(seatsPercentage\r\n          ? { seatsPercentage: { $gte: seatsPercentage } }\r\n          : {}),\r\n        ...(search ? { name: { $regex: new RegExp(search, \"i\") } } : {}),\r\n        ...(hall ? { hall: hallId } : {})\r\n      })\r\n        .skip(skip)\r\n        .limit(10)\r\n        .populate(\"hall\")) as (EventType & { hall: HallType })[]\r\n    ).map((event: EventType & { hall: HallType }) => ({\r\n      ...event.toObject(),\r\n      hall: (event.hall as unknown as EventType)?.name || \"\"\r\n    }));\r\n\r\n    if (currentEvents.length === 0) {\r\n      return res.status(200).json({\r\n        events: [],\r\n        totalPages: 0,\r\n        page: 1\r\n      });\r\n    }\r\n    const totalPages = Math.ceil(currentEvents.length / 10);\r\n\r\n    return res.status(200).json({\r\n      events: currentEvents,\r\n      totalPages,\r\n      page\r\n    });\r\n  } catch (error) {\r\n    next(new AppError(\"Error fetching events\", 400));\r\n  }\r\n};\r\n\r\nexport const getEventById = async (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction\r\n) => {\r\n  try {\r\n    const eventModel = await Event.findById(req.params.id).populate(\"hall\");\r\n    if (!eventModel) {\r\n      return res.status(404).json({ message: \"Event not found\" });\r\n    }\r\n    res.status(200).json({\r\n      ...eventModel.toObject(),\r\n      hall: (eventModel.hall as any)?.name || \"\"\r\n    });\r\n  } catch (error) {\r\n    next(new AppError(\"Error fetching event\", 400));\r\n  }\r\n};\r\n\r\nexport const updateEvent = async (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction\r\n) => {\r\n  try {\r\n    const { name, description, date, location, seatsAvailable } = req.body;\r\n    const event = await Event.findByIdAndUpdate(\r\n      req.params.id,\r\n      {\r\n        _id: new mongoose.Types.ObjectId(),\r\n        name,\r\n        description,\r\n        date,\r\n        location,\r\n        seatsAvailable\r\n      },\r\n      { new: true }\r\n    );\r\n\r\n    if (!event) {\r\n      return res.status(404).json({ message: \"Event not found\" });\r\n    }\r\n\r\n    res.status(200).json({ message: \"Event updated successfully\", event });\r\n  } catch (error) {\r\n    next(new AppError(\"Error updating event\", 400));\r\n  }\r\n};\r\n\r\nexport const deleteEvent = async (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction\r\n) => {\r\n  try {\r\n    const event = await Event.findByIdAndDelete(req.params.id);\r\n    if (!event) {\r\n      return res.status(404).json({ message: \"Event not found\" });\r\n    }\r\n\r\n    res.status(200).json({ message: \"Event deleted successfully\" });\r\n  } catch (error) {\r\n    next(new AppError(\"Error deleting event\", 400));\r\n  }\r\n};\r\n"]}